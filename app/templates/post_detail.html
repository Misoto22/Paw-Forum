<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  {% extends "base.html" %} {% block content %}
<div class="forum-detail">
  <div class="forum-header">
    <img
      src="{{ url_for('static', filename='image/avatars/' + post.user.user_image) }}"
      alt="User Avatar"
      class="avatar">
    <div class="user-info">
      <span class="username">{{ post.user.username }}</span>
      <span class="post-time">{{ post.created_at.strftime('%Y-%m-%d %H:%M:%S') if post.created_at else 'N/A' }}</span>
    </div>
  </div>

  <h2 class="forum-title">
    {% if post.is_task %}
    <img src="{{ url_for('static', filename='image/task-icon.png') }}" alt="Task Icon" class="task-icon">
    {% endif %}
    {{ post.title }}
  </h2>
  <p class="forum-description">{{ post.content }}</p>
  <div class="forum-image-detail">
    {% if post.image_name %}
    <img
      src="{{ url_for('static', filename='image/uploads/' + post.image_name) }}"
      alt="Post Image">
    {% endif %}
  </div>

  <div class="forum-footer">
    <span class="likes">
      <img
        src="{{ url_for('static', filename='image/like.png') }}"
        alt="Like"
        class="like-icon"
        id="likeToggleDetail">
      <span id="likeCount">{{ post.like_count }}</span>
    </span>
    <span class="comments">
      <img
        src="{{ url_for('static', filename='image/comment.png') }}"
        alt="Comment"
        class="comment-icon">
      <span id="commentCount">{{ post.comment_count }}</span>
    </span>

    {% if current_user.id == post.created_by %}
    <span class="delete">
      <img
        src="{{ url_for('static', filename='image/bin.png') }}"
        alt="Delete"
        class="delete-icon"
        id="deletePost">
    </span>
    {% endif %}

    <div id="deleteModal" class="modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <p>Are you sure you want to delete this post?</p>
        <button id="confirmDelete" class="btn-confirm">Yes</button>
        <button id="cancelDelete" class="btn-cancel">No</button>
      </div>
    </div>
  </div>

  <div class="reply-section">
    <div class="reply-form">
      <p>Add a comment</p>
      <form
        id="replyForm"
        method="POST"
        action="{{ url_for('post_reply', post_id=post.id) }}">
        <textarea name="content" placeholder="Write your reply here"></textarea>
        <button type="submit" id="submitReplyBtn">Submit</button>
        <input type="hidden" name="parent_reply_id" id="parentReplyId">
      </form>
    </div>

    <div class="replies">
      {% for reply in replies %}
      {% set reply_context = reply %}
      {% include 'components/reply.html' with context %}
      {% endfor %}
    </div>
  </div>
  {% include "components/post_reply.html" %}
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    var modal = document.getElementById("deleteModal");
    var deleteIcon = document.getElementById("deletePost");
    var closeBtn = document.getElementsByClassName("close-btn")[0];
    var confirmDelete = document.getElementById("confirmDelete");
    var cancelDelete = document.getElementById("cancelDelete");
    var likeIcon = document.getElementById("likeToggleDetail");
    var likeCount = document.getElementById("likeCount");

    if (likeIcon) {
      likeIcon.addEventListener("click", function () {
        fetch("{{ url_for('like_post', post_id=post.id) }}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        })
        .then((response) => response.json())
        .then((data) => {
          likeCount.textContent = data.like_count;
          likeIcon.src = data.liked
            ? "{{ url_for('static', filename='image/liked.png') }}"
            : "{{ url_for('static', filename='image/like.png') }}";
        })
        .catch((error) => console.error("Error:", error));
      });
    }

    if (deleteIcon) {
      deleteIcon.onclick = function () {
        modal.style.display = "block";
      };

      closeBtn.onclick = function () {
        modal.style.display = "none";
      };

      cancelDelete.onclick = function () {
        modal.style.display = "none";
      };

      confirmDelete.onclick = function () {
        fetch("{{ url_for('delete_post', post_id=post.id) }}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        })
        .then((response) => {
          if (response.ok) {
            alert("Post deleted successfully.");
            window.location.href = "{{ url_for('home') }}";
          } else {
            return response.json().then((data) => {
              alert("Error: " + data.error);
              modal.style.display = "none";
            });
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("Error deleting post.");
          modal.style.display = "none";
        });
      };

      window.onclick = function (event) {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      };
    }
  });
</script>
{% endblock %}
</body>
</html>
