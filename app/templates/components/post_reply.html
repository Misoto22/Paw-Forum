{% block content %}
<div class="forum-container">
  <div class="forum-header">
  </div>

  <!-- User list container inside forum detail -->
  <div class="user-list-container">
    <div class="user-list">
      <button id="action-button" class="action-button">Apply</button>

      {% for waiting_user in post.waiting_list %}
      <div class="user" 
          username="{{ waiting_user.user.username }}">
          <img src="{{ url_for('static', filename='image/avatars/' ~ waiting_user.user.user_image) }}" alt="User Avatar" class="user-avatar" />
          <span class="user-username">{{ waiting_user.user.username }}</span>
      </div>
      {% endfor %}
<!--
      <div
        class="user"
        data-username="jane_smith"
        data-name="Jane Smith"
        data-gender="Female"
        data-postcode="67890"
        data-email="jane@example.com"
        data-phone="987-654-3210"
        data-pettype="Cat"
      >
        <img
          src="{{ url_for('static', filename='image/avatars/avatar21.png') }}"
          alt="User Avatar"
          class="user-avatar"
        />
        <span class="user-username">jane_smith</span>
      </div>
-->
    </div>
  </div>

  <!-- User info popup -->
  <div id="user-info-popup" class="user-info-popup">
    <div class="popup-content">
      <span class="close-popup">&times;</span>
      <p><strong>Username:</strong> <span id="popup-username"></span></p>
      <p><strong>Email:</strong> <span id="popup-email"></span></p>
      <p><strong>Phone:</strong> <span id="popup-phone"></span></p>
      <p><strong>Gender:</strong> <span id="popup-gender"></span></p>
      <p><strong>Postcode:</strong> <span id="popup-postcode"></span></p>
    </div>
  </div>

   <!-- Reply Section-->
  <div class="reply-section">
    <div class="reply-form">
      <p>Add a comment</p>
      <textarea placeholder="Write your reply here "></textarea>
      <button id="submitReplyBtn">Submit</button>
    </div>

    <div class="replies">
      {% for reply in post.replies %}
      <div class="reply">
        <div class="reply-header">
          <img src="{{ reply.user.user_image }}" alt="User Avatar" class="reply-avatar" />
          <span class="reply-username">{{ reply.user.username }}</span>
          <span class="reply-time">{{ reply.post_at.strftime('%Y-%m-%d %H:%M') }}</span>
        </div>
        <div class="reply-content">{{ reply.content }}</div>
        <div class="reply-footer">
          <button class="reply-button">Reply</button>
          
          <!-- Add delete icon for reply -->
          <span class="delete">
            <img
              src="{{ url_for('static', filename='image/bin.png') }}"
              alt="Delete"
              class="delete-icon delete-reply"
            />
          </span>
        </div>
        <div class="nested-reply-form">
          <textarea placeholder="Write your reply..."></textarea>
          <button class="submit-nested-reply">Reply</button>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Delete confirmation modal -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <p>Are you sure you want to delete this post/comment?</p>
    <button id="confirmDelete" class="btn-confirm">Yes</button>
    <button id="cancelDelete" class="btn-cancel">No</button>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  //Add username and avatar to task list
  document.addEventListener("DOMContentLoaded", function () {
    const actionButton = document.getElementById("action-button");
    const userListContainer = document.querySelector(".user-list");
    actionButton.addEventListener("click", function () {
      if (!actionButton.disabled) {
        const currentUserUsername = "{{ current_user.username }}";
        const currentUserAvatar = "{{ current_user.user_image }}";

        // Create a new user element
        const newUserElement = document.createElement("div");
        newUserElement.className = "user";
        newUserElement.setAttribute("username", currentUserUsername);

        // Create avatar image element
        const avatarElement = document.createElement("img");
        avatarElement.src = currentUserAvatar;
        avatarElement.alt = "User Avatar";
        avatarElement.className = "user-avatar";

        // Create username element
        const usernameElement = document.createElement("span");
        usernameElement.className = "user-username";
        usernameElement.textContent = currentUserUsername;

        // Append avatar and username to the new user element
        newUserElement.appendChild(avatarElement);
        newUserElement.appendChild(usernameElement);

        // Append the new user element to the user list container
        userListContainer.appendChild(newUserElement);

        // Disable the action button and change its appearance
        actionButton.disabled = true;
        actionButton.style.backgroundColor = "grey";
        actionButton.innerText = "Applied";
      }
    });
  });

  //Delete function
  document.addEventListener("DOMContentLoaded", function () {
    // Get modal elements
    var modal = document.getElementById("deleteModal");
    var closeBtn = document.getElementsByClassName("close-btn")[0];
    var confirmDelete = document.getElementById("confirmDelete");
    var cancelDelete = document.getElementById("cancelDelete");
    var deleteTarget; // To store the element to be deleted

    // Show modal on delete icon click
    document.querySelectorAll(".delete-icon").forEach(function (deleteIcon) {
      deleteIcon.onclick = function () {
        modal.style.display = "block";
        deleteTarget = this; // Store the delete icon that was clicked
      };
    });

    // Hide modal on close button click
    closeBtn.onclick = function () {
      modal.style.display = "none";
    };

    // Hide modal on cancel button click
    cancelDelete.onclick = function () {
      modal.style.display = "none";
    };

    // Handle confirm delete button click
    confirmDelete.onclick = function () {
      // Placeholder for AJAX request to delete post/comment
      alert("Deleted successfully."); // Replace with actual AJAX request
      modal.style.display = "none";

      // Remove the target element from DOM
      if (deleteTarget) {
        deleteTarget.closest(".reply, .forum-detail").remove();
      }
    };

    // Hide modal when clicking outside the modal content
    window.onclick = function (event) {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    };
  });
</script>
<script src="{{ url_for('static', filename='js/topic_reply.js') }}"></script>
<script src="{{ url_for('static', filename='js/user_info_popup.js') }}"></script>
{% endblock %}
